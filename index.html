<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dormie | PDF Link Status Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Libre+Baskerville&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dormie-sage': '#A8AD97',
                        'dormie-beige': '#F9F7F2',
                        'dormie-dark': '#3D3D3D',
                        'dormie-accent': '#EAE8E3',
                        'dormie-offwhite': '#FCFCFA',
                        'dormie-warn': '#D97706',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'serif': ['Libre Baskerville', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F9F7F2; color: #3D3D3D; scroll-behavior: smooth; }
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        .status-chip { display: inline-flex; align-items: center; padding: 0.25rem 0.6rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 500; }
        .status-chip .dot { width: 6px; height: 6px; border-radius: 50%; margin-right: 6px; }
        
        .status-ok { color: #166534; background-color: #ECFDF5; } .status-ok .dot { background-color: #22C55E; }
        .status-blocked { color: #92400E; background-color: #FFFBEB; } .status-blocked .dot { background-color: #F59E0B; }
        .status-broken { color: #991B1B; background-color: #FEF2F2; } .status-broken .dot { background-color: #EF4444; }
        .status-checking { color: #374151; background-color: #F3F4F6; } .status-checking .dot { background-color: #6B7280; }
        .status-error { color: #374151; background-color: #F3F4F6; } .status-error .dot { background-color: #EF4444; }
        .status-manual-ok { color: #166534; background-color: #ECFDF5; border: 1px solid #D1FAE5; } .status-manual-ok .dot { background-color: #22C55E; }
        .status-manual-broken { color: #991B1B; background-color: #FEF2F2; border: 1px solid #FEE2E2; } .status-manual-broken .dot { background-color: #EF4444; }
        .status-manual-required { color: #92400E; background-color: #FFFBEB; border: 1px solid #FEF3C7;} .status-manual-required .dot { background-color: #F59E0B; }
        
        .drag-over { border-color: #A8AD97; background-color: #EFEBE4; }

        .indicator-bulb { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 10px; transition: background-color 0.3s ease; }
        .bulb-red { background-color: #EF4444; }
        .bulb-yellow { background-color: #F59E0B; }
        .bulb-green { background-color: #22C55E; }

        .highlight-problem { box-shadow: 0 0 0 2px #A8AD97; border-radius: 0.5rem; }
    </style>
</head>
<body class="bg-dormie-beige text-dormie-dark">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="text-center mb-10">
            <h1 class="font-serif text-4xl sm:text-5xl text-dormie-dark">PDF Link Checker</h1>
            <p class="mt-3 text-gray-500 text-base">A tool for Dormie to verify PDF hyperlinks.</p>
        </header>

        <main class="pb-40">
            <!-- Control Panel -->
            <div class="bg-dormie-offwhite border border-dormie-accent p-4 rounded-lg relative mb-8 flex flex-col sm:flex-row items-center justify-between shadow-sm gap-4">
                <div class="flex items-center">
                    <span id="indicator-bulb" class="indicator-bulb bulb-yellow"></span>
                    <div>
                        <strong id="indicator-title" class="font-semibold text-dormie-dark">Link Checker Status</strong>
                        <p id="indicator-text" class="text-sm text-gray-500">Checking activation status...</p>
                    </div>
                </div>
                <button id="activate-button" class="px-5 py-2 bg-dormie-dark hover:bg-opacity-90 rounded-md text-white font-semibold transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">Activate Tool</button>
            </div>

            <!-- File Upload Section -->
            <div id="upload-container" class="mb-8">
                <label for="pdf-upload" class="flex flex-col items-center justify-center w-full h-48 border-2 border-dormie-accent border-dashed rounded-lg cursor-pointer bg-dormie-offwhite hover:bg-dormie-beige/50 transition-colors">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <svg class="w-10 h-10 mb-3 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                        <p class="mb-2 text-sm text-gray-500"><span class="font-semibold text-dormie-sage">Click to upload</span> or drag and drop</p>
                        <p class="text-xs text-gray-400">PDF files only (scans page 2 only)</p>
                    </div>
                    <input id="pdf-upload" type="file" class="hidden" accept=".pdf" multiple />
                </label>
            </div>

            <!-- Loading Spinner -->
            <div id="loading-spinner" class="text-center my-10 hidden">
                 <svg class="animate-spin h-8 w-8 text-dormie-sage mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="mt-2 text-gray-500">Processing files and checking links...</p>
            </div>

            <!-- Results Section -->
            <div id="results-container"></div>
        </main>
    </div>

    <!-- Floating Review Widget -->
    <div id="review-widget" class="hidden fixed bottom-5 right-5 bg-dormie-offwhite/80 backdrop-blur-md p-3 rounded-lg shadow-2xl border border-dormie-accent w-64">
        <p class="text-sm font-semibold text-dormie-dark mb-2">Review Problem Links</p>
        <div class="flex items-center justify-between">
            <span id="problem-count" class="text-sm text-gray-600">0 links need attention</span>
            <div class="flex gap-2">
                <button id="prev-problem" class="p-2 bg-dormie-beige hover:bg-dormie-accent rounded-md text-dormie-dark transition-colors">&lt;</button>
                <button id="next-problem" class="p-2 bg-dormie-beige hover:bg-dormie-accent rounded-md text-dormie-dark transition-colors">&gt;</button>
            </div>
        </div>
        <div id="widget-notice" class="hidden mt-2 text-center text-sm bg-dormie-warn/10 text-dormie-warn p-2 rounded-md border border-dormie-warn/20"></div>
    </div>

    <script type="module">
        // --- DOM Elements ---
        const uploadInput = document.getElementById('pdf-upload'), uploadContainer = document.getElementById('upload-container'), resultsContainer = document.getElementById('results-container'), loadingSpinner = document.getElementById('loading-spinner'), activateButton = document.getElementById('activate-button'), indicatorBulb = document.getElementById('indicator-bulb'), indicatorText = document.getElementById('indicator-text'), reviewWidget = document.getElementById('review-widget'), problemCountSpan = document.getElementById('problem-count'), prevProblemBtn = document.getElementById('prev-problem'), nextProblemBtn = document.getElementById('next-problem'), widgetNotice = document.getElementById('widget-notice');

        // --- State Variables ---
        const PROXY_URL = 'https://cors-anywhere.herokuapp.com/', REQUEST_DELAY = 500;
        let proxyCheckInterval = null, linkQueue = [], problematicLinks = [], isQueueProcessing = false, currentProblemIndex = -1;

        // --- Activation & Proxy Logic ---
        function updateIndicator(color, text, isButtonEnabled = true) {
            indicatorBulb.className = `indicator-bulb bulb-${color}`;
            indicatorText.textContent = text;
            activateButton.disabled = !isButtonEnabled;
        }

        async function checkProxyStatus() {
            try {
                const response = await fetch(`${PROXY_URL}https://example.com`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                if (response.ok) {
                    updateIndicator('green', 'Ready to check links.', false);
                    activateButton.textContent = "Activated";
                    if (proxyCheckInterval) clearInterval(proxyCheckInterval);
                } else {
                    updateIndicator('red', 'Activation required. Click button to enable.', true);
                }
            } catch (error) {
                updateIndicator('red', 'Could not connect to activation service.', true);
                if (proxyCheckInterval) clearInterval(proxyCheckInterval);
            }
        }
        activateButton.addEventListener('click', () => {
            window.open(`${PROXY_URL}corsdemo`, '_blank');
            updateIndicator('yellow', 'Waiting for activation in new tab...', false);
            if (proxyCheckInterval) clearInterval(proxyCheckInterval);
            proxyCheckInterval = setInterval(checkProxyStatus, 3000);
        });

        // --- File Handling & Processing ---
        uploadContainer.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); uploadContainer.querySelector('label').classList.add('drag-over'); });
        uploadContainer.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); uploadContainer.querySelector('label').classList.remove('drag-over'); });
        uploadContainer.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); uploadContainer.querySelector('label').classList.remove('drag-over'); handleFileSelection({ target: { files: e.dataTransfer.files } }); });
        uploadInput.addEventListener('change', handleFileSelection);

        async function handleFileSelection(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            resultsContainer.innerHTML = '';
            loadingSpinner.classList.remove('hidden');
            linkQueue = []; problematicLinks = []; currentProblemIndex = -1;
            updateReviewWidget();
            widgetNotice.classList.add('hidden');

            for (const file of files) {
                if (file.type === 'application/pdf') await processPdf(file);
            }
            loadingSpinner.classList.add('hidden');
            if (!isQueueProcessing) processLinkQueue();
        }

        async function processPdf(file) {
            const fileId = `file-${Date.now()}`;
            const fileResultHtml = `<div class="bg-dormie-offwhite rounded-lg shadow-sm mb-6" id="${fileId}"><div class="p-4 border-b border-dormie-accent"><h2 class="text-lg font-semibold text-dormie-dark truncate">${file.name}</h2></div><div class="p-4 space-y-2"></div></div>`;
            resultsContainer.insertAdjacentHTML('beforeend', fileResultHtml);
            const listElement = document.getElementById(fileId).querySelector('.space-y-2');
            const uniqueUrls = new Map();

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                if (pdf.numPages < 2) {
                    listElement.innerHTML = `<p class="text-gray-500">This PDF has fewer than 2 pages. No links were scanned.</p>`;
                    return;
                }

                const page = await pdf.getPage(2);
                const annotations = await page.getAnnotations();
                const textContent = await page.getTextContent();
                
                annotations.filter(anno => anno.subtype === 'Link' && anno.url).forEach(anno => {
                    const url = anno.url;
                    if (!uniqueUrls.has(url)) {
                        const linkText = findTextForAnnotation(anno, textContent) || 'Image or non-text link';
                        const linkId = `link-${Date.now()}-${Math.random()}`;
                        uniqueUrls.set(url, { text: linkText, id: linkId });
                        
                        const listItem = document.createElement('div');
                        listItem.id = linkId;
                        listItem.className = 'p-3 bg-dormie-offwhite border border-dormie-accent rounded-lg flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 transition-shadow duration-300';
                        listItem.innerHTML = `
                            <div class="flex-grow overflow-hidden">
                                <p class="text-base font-semibold text-dormie-dark truncate" title="${linkText}">${linkText}</p>
                                <p class="text-xs text-gray-400 truncate">URL: <a href="${url}" target="_blank" class="text-dormie-sage hover:underline">${url}</a></p>
                                <p class="text-xs text-gray-400 truncate final-url-container" style="display: none;">Final: <span class="final-url text-gray-600"></span></p>
                            </div>
                            <div class="flex-shrink-0 flex items-center gap-3">
                                <div class="manual-actions hidden"></div>
                                <div class="status-container w-32 text-right">
                                    <span class="status-chip status-checking"><span class="dot"></span>Queued</span>
                                </div>
                            </div>`;
                        listElement.appendChild(listItem);
                        linkQueue.push({ url: url, elementId: linkId });
                    }
                });
                
                if (uniqueUrls.size === 0) listElement.innerHTML = `<p class="text-gray-500">No unique links found on page 2.</p>`;
            } catch (error) {
                document.getElementById(fileId).querySelector('.p-4').innerHTML = `<p class="text-red-600">Could not process PDF.</p>`;
            }
        }
        
        function findTextForAnnotation(anno, textContent) {
            const [x1, y1, x2, y2] = anno.rect;
            let linkText = '';
            for (const item of textContent.items) {
                const tx = item.transform[4], ty = item.transform[5];
                if (tx >= x1 && tx <= x2 && ty >= y1 && ty <= y2) {
                    linkText += item.str;
                }
            }
            return linkText.trim();
        }

        // --- Link Checking Queue ---
        async function processLinkQueue() {
            isQueueProcessing = true;
            if (linkQueue.length === 0) { isQueueProcessing = false; return; }
            
            const task = linkQueue.shift();
            
            const listItem = document.getElementById(task.elementId);
            if (listItem) listItem.querySelector('.status-container').innerHTML = `<span class="status-chip status-checking"><span class="dot"></span>Checking</span>`;
            
            const isRateLimited = await checkLinkStatus(task.url, task.elementId);

            if (isRateLimited) {
                linkQueue.unshift(task);
                isQueueProcessing = false;
                handleRateLimitFallback();
                return;
            }
            
            setTimeout(processLinkQueue, REQUEST_DELAY);
        }

        function handleRateLimitFallback() {
            widgetNotice.textContent = 'Rate limit hit. Please check remaining links manually.';
            widgetNotice.classList.remove('hidden');
            reviewWidget.classList.remove('hidden');
            
            linkQueue.forEach(task => {
                const listItem = document.getElementById(task.elementId);
                if (listItem) {
                    const statusContainer = listItem.querySelector('.status-container');
                    statusContainer.innerHTML = `<span class="status-chip status-manual-required"><span class="dot"></span>Manual Check</span>`;
                    problematicLinks.push(task.elementId);
                    addManualActions(task.elementId);
                }
            });
            linkQueue = [];
            updateReviewWidget();
        }

        async function checkLinkStatus(url, elementId) {
            const listItem = document.getElementById(elementId);
            if (!listItem) return false;
            const statusContainer = listItem.querySelector('.status-container'), finalUrlContainer = listItem.querySelector('.final-url-container'), finalUrlSpan = listItem.querySelector('.final-url');
            
            let isOk = false;
            try {
                const response = await fetch(`${PROXY_URL}${url}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                let statusChip;
                if (response.ok) { isOk = true; statusChip = '<span class="status-chip status-ok"><span class="dot"></span>OK</span>'; } 
                else if (response.status === 403) { statusChip = `<span class="status-chip status-blocked"><span class="dot"></span>Blocked</span>`; } 
                else if (response.status === 429) { return true; } 
                else { statusChip = `<span class="status-chip status-broken"><span class="dot"></span>Broken</span>`; }
                statusContainer.innerHTML = statusChip;
                const finalUrl = response.url.replace(PROXY_URL, '');
                if (finalUrl !== url) { finalUrlSpan.textContent = finalUrl; finalUrlContainer.style.display = 'block'; }
            } catch (error) {
                statusContainer.innerHTML = '<span class="status-chip status-error"><span class="dot"></span>Error</span>';
                finalUrlSpan.textContent = 'Could not reach server.';
                finalUrlContainer.style.display = 'block';
            }

            if (!isOk) {
                problematicLinks.push(elementId);
                addManualActions(elementId);
                updateReviewWidget();
            }
            return false;
        }

        // --- Review Widget & Manual Override Logic ---
        function addManualActions(elementId) {
            const actionsContainer = document.getElementById(elementId)?.querySelector('.manual-actions');
            if (!actionsContainer) return;
            actionsContainer.classList.remove('hidden');
            actionsContainer.innerHTML = `<div class="flex gap-2">
                <button title="Mark as OK" class="mark-ok-btn p-1.5 bg-green-500/10 hover:bg-green-500/20 rounded-md text-green-500/70 hover:text-green-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                </button>
                <button title="Mark as Broken" class="mark-broken-btn p-1.5 bg-red-500/10 hover:bg-red-500/20 rounded-md text-red-500/70 hover:text-red-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>`;
            actionsContainer.querySelector('.mark-ok-btn').addEventListener('click', () => handleManualOverride(elementId, true));
            actionsContainer.querySelector('.mark-broken-btn').addEventListener('click', () => handleManualOverride(elementId, false));
        }

        function handleManualOverride(elementId, isMarkingOk) {
            const listItem = document.getElementById(elementId), statusContainer = listItem.querySelector('.status-container'), actionsContainer = listItem.querySelector('.manual-actions');
            if (isMarkingOk) {
                statusContainer.innerHTML = `<span class="status-chip status-manual-ok"><span class="dot"></span>Manual OK</span>`;
                problematicLinks = problematicLinks.filter(id => id !== elementId);
                listItem.classList.remove('highlight-problem');
                updateReviewWidget();
            } else {
                statusContainer.innerHTML = `<span class="status-chip status-manual-broken"><span class="dot"></span>Manual Broken</span>`;
            }
            actionsContainer.innerHTML = '';
        }

        function updateReviewWidget() {
            const count = problematicLinks.length;
            reviewWidget.classList.toggle('hidden', count === 0 && widgetNotice.classList.contains('hidden'));
            problemCountSpan.textContent = `${count} link${count > 1 ? 's' : ''} need attention`;
            if (count === 0 && currentProblemIndex !== -1) {
                if (problematicLinks[currentProblemIndex]) document.getElementById(problematicLinks[currentProblemIndex])?.classList.remove('highlight-problem');
                currentProblemIndex = -1;
            }
        }

        function navigateProblems(direction) {
            if (problematicLinks.length === 0) return;
            if (currentProblemIndex !== -1) document.getElementById(problematicLinks[currentProblemIndex])?.classList.remove('highlight-problem');
            currentProblemIndex = (currentProblemIndex + direction + problematicLinks.length) % problematicLinks.length;
            const element = document.getElementById(problematicLinks[currentProblemIndex]);
            if (element) {
                element.classList.add('highlight-problem');
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        prevProblemBtn.addEventListener('click', () => navigateProblems(-1));
        nextProblemBtn.addEventListener('click', () => navigateProblems(1));
        window.onload = checkProxyStatus;
    </script>
</body>
</html>
